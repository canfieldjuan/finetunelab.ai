# Predictions API Investigation Report
**Job ID:** `63db0784-951b-4a18-a048-df4d46239c62`  
**Date:** 2025-12-06  
**Status:** FIXED âœ…

---

## Root Cause Analysis

The investigation revealed a critical failure chain in the **Local Training** workflow that prevented predictions from being saved.

### 1. Job Creation Failure (Silent)
The `train.py` script generated by `local-package-generator.ts` was failing to create the training job in the database because:
- It did not send the required `job_id` in the payload (API requires it).
- It did not send the required `user_id` in the payload (API requires it).
- It expected a `201 Created` status code, but the API returns `200 OK` or `202 Accepted`.

**Result:** `create_local_job` returned `None`, causing `train.py` to disable predictions/metrics tracking locally.
*(The job `63db0784...` in the DB was likely created by a different process or manual intervention, but the training script didn't link to it correctly).*

### 2. Invalid User ID (If Job Created)
Even if the job creation succeeded, `train.py` was hardcoding `JOB_USER_ID="local-user"`.
- `PredictionsWriter` sends this ID to the API.
- The API tries to insert it into `training_predictions`.
- **Supabase rejects the insert** because `"local-user"` is not a valid UUID matching `auth.users`.

---

## Fixes Applied

### 1. Updated API Endpoint (`app/api/training/local/jobs/route.ts`)
- **Robustness:** Now extracts `user_id` from the `Authorization` header (JWT) if it's missing from the request body.
- **Response:** Now returns `user_id` and `job_id` in the JSON response, allowing the client to know the authenticated user's ID.

### 2. Updated Package Generator (`lib/training/local-package-generator.ts`)
- **ID Generation:** Now generates `job_id` locally and sends it in the payload.
- **Status Handling:** Now accepts `200`, `201`, and `202` status codes.
- **User ID:** Now captures the real `user_id` returned by the API.
- **Environment:** Sets `JOB_USER_ID` to the real UUID instead of `"local-user"`.

---

## Verification
These changes ensure that:
1. `train.py` successfully creates the job in the database.
2. `train.py` receives the correct `user_id`.
3. `PredictionsWriter` initializes with the correct `user_id`.
4. Predictions are saved to the database with a valid foreign key.

**Next Steps:**
- Generate a new training package.
- Run a new training job.
- Verify predictions appear in the database.

---

**Files Modified:**
- `app/api/training/local/jobs/route.ts`
- `lib/training/local-package-generator.ts`

**Files Verified (No Changes Needed):**
- `app/api/training/predictions/[jobId]/route.ts` (Correct)
- `lib/training/predictions_writer.py` (Correct logic, was just fed bad data)
