#!/usr/bin/env node
/**
 * Environment Configuration Loader
 * Loads .env file and merges with config.json
 */

import fs from 'fs/promises';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

/**
 * Parse .env file contents
 */
function parseEnvFile(content) {
  const env = {};
  const lines = content.split('\n');

  for (const line of lines) {
    // Skip empty lines and comments
    if (!line.trim() || line.trim().startsWith('#')) {
      continue;
    }

    // Parse KEY=VALUE
    const match = line.match(/^([^=]+)=(.*)$/);
    if (match) {
      const key = match[1].trim();
      let value = match[2].trim();

      // Remove quotes if present
      if ((value.startsWith('"') && value.endsWith('"')) ||
          (value.startsWith("'") && value.endsWith("'"))) {
        value = value.slice(1, -1);
      }

      env[key] = value;
    }
  }

  return env;
}

/**
 * Load .env file if it exists
 */
async function loadEnvFile() {
  const envPath = path.join(__dirname, '..', '.env');

  try {
    const content = await fs.readFile(envPath, 'utf8');
    return parseEnvFile(content);
  } catch (error) {
    if (error.code === 'ENOENT') {
      // .env file doesn't exist, return empty object
      return {};
    }
    throw error;
  }
}

/**
 * Load config.json and merge with .env values
 */
export async function loadConfig() {
  const configPath = path.join(__dirname, '..', 'config.json');
  const config = JSON.parse(await fs.readFile(configPath, 'utf8'));
  const env = await loadEnvFile();

  // Merge environment variables with config
  if (env.OLLAMA_CLOUD_API_KEY) {
    config.ollama.cloud.api_key = env.OLLAMA_CLOUD_API_KEY;
  }

  if (env.OLLAMA_CLOUD_BASE_URL) {
    config.ollama.cloud.base_url = env.OLLAMA_CLOUD_BASE_URL;
  }

  if (env.OLLAMA_CLOUD_TIMEOUT_MS) {
    config.ollama.cloud.timeout_ms = parseInt(env.OLLAMA_CLOUD_TIMEOUT_MS, 10);
  }

  if (env.OLLAMA_LOCAL_BASE_URL) {
    config.ollama.local.base_url = env.OLLAMA_LOCAL_BASE_URL;
  }

  if (env.OLLAMA_LOCAL_TIMEOUT_MS) {
    config.ollama.local.timeout_ms = parseInt(env.OLLAMA_LOCAL_TIMEOUT_MS, 10);
  }

  return config;
}

/**
 * Check if .env file exists
 */
export async function hasEnvFile() {
  const envPath = path.join(__dirname, '..', '.env');
  try {
    await fs.access(envPath);
    return true;
  } catch {
    return false;
  }
}

/**
 * Save API key to .env file
 */
export async function saveApiKeyToEnv(apiKey, options = {}) {
  const envPath = path.join(__dirname, '..', '.env');

  // Load existing .env or start fresh
  let env = {};
  try {
    const content = await fs.readFile(envPath, 'utf8');
    env = parseEnvFile(content);
  } catch (error) {
    if (error.code !== 'ENOENT') {
      throw error;
    }
  }

  // Update values
  env.OLLAMA_CLOUD_API_KEY = apiKey;

  if (options.baseUrl) {
    env.OLLAMA_CLOUD_BASE_URL = options.baseUrl;
  }

  if (options.timeout) {
    env.OLLAMA_CLOUD_TIMEOUT_MS = options.timeout.toString();
  }

  // Build .env file content
  const lines = [
    '# Ollama Cloud API Configuration',
    '# Generated by ts:setup-cloud',
    '',
    `OLLAMA_CLOUD_API_KEY=${env.OLLAMA_CLOUD_API_KEY || ''}`,
  ];

  if (env.OLLAMA_CLOUD_BASE_URL) {
    lines.push(`OLLAMA_CLOUD_BASE_URL=${env.OLLAMA_CLOUD_BASE_URL}`);
  }

  if (env.OLLAMA_CLOUD_TIMEOUT_MS) {
    lines.push(`OLLAMA_CLOUD_TIMEOUT_MS=${env.OLLAMA_CLOUD_TIMEOUT_MS}`);
  }

  if (env.OLLAMA_LOCAL_BASE_URL) {
    lines.push('');
    lines.push('# Local Ollama configuration');
    lines.push(`OLLAMA_LOCAL_BASE_URL=${env.OLLAMA_LOCAL_BASE_URL}`);
  }

  if (env.OLLAMA_LOCAL_TIMEOUT_MS) {
    lines.push(`OLLAMA_LOCAL_TIMEOUT_MS=${env.OLLAMA_LOCAL_TIMEOUT_MS}`);
  }

  lines.push('');

  await fs.writeFile(envPath, lines.join('\n'));
}
