-- Migration: Add Token Columns to Demo Batch Test Results
-- Date: 2026-01-01
-- Purpose: Fix bug where input_tokens and output_tokens fail to insert
-- Related: BYOM Demo Phase 1 - Token Storage Bug Fix
--
-- Problem: app/api/demo/v2/batch-test/route.ts tries to INSERT input_tokens
-- and output_tokens but these columns don't exist, causing silent failures
-- and resulting in zero metrics for success rate, latency, and token usage.
--
-- Solution: Add these columns as nullable integers (some providers may not return tokens)

-- ============================================================================
-- Add Token Columns to demo_batch_test_results
-- ============================================================================

ALTER TABLE demo_batch_test_results
  ADD COLUMN IF NOT EXISTS input_tokens INTEGER,
  ADD COLUMN IF NOT EXISTS output_tokens INTEGER;

-- ============================================================================
-- Add Comments for Documentation
-- ============================================================================

COMMENT ON COLUMN demo_batch_test_results.input_tokens IS
  'Number of input tokens sent to the model (from usage.prompt_tokens in API response). Null if provider does not return token counts.';

COMMENT ON COLUMN demo_batch_test_results.output_tokens IS
  'Number of output tokens generated by the model (from usage.completion_tokens in API response). Null if provider does not return token counts.';

-- ============================================================================
-- Verification Query
-- To verify migration worked, run:
-- SELECT column_name, data_type, is_nullable
-- FROM information_schema.columns
-- WHERE table_name = 'demo_batch_test_results'
-- AND column_name IN ('input_tokens', 'output_tokens');
-- ============================================================================
