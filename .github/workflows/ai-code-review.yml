name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - '**.ts'
      - '**.tsx'
      - '**.js'
      - '**.jsx'

jobs:
  code-review:
    runs-on: self-hosted # Use your local machine with RTX 3090 + Ollama

    permissions:
      contents: read
      pull-requests: write # Needed to post comments on PRs

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch all history to compare with base branch

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check Ollama is running
        run: |
          if ! curl -s http://localhost:11434/api/tags > /dev/null; then
            echo "‚ùå Ollama is not running. Start it with: ollama serve"
            exit 1
          fi
          echo "‚úÖ Ollama is running"

      - name: Check model availability
        run: |
          if ! ollama list | grep -q "qwen2.5-coder:32b"; then
            echo "‚ùå Model qwen2.5-coder:32b not found"
            echo "Pull it with: ollama pull qwen2.5-coder:32b"
            exit 1
          fi
          echo "‚úÖ Model qwen2.5-coder:32b is available"

      - name: Get changed files
        id: changed-files
        run: |
          # Get list of changed TypeScript/JavaScript files
          CHANGED_FILES=$(git diff --name-only --diff-filter=ACM origin/${{ github.base_ref }}..HEAD | grep -E '\.(ts|tsx|js|jsx)$' || true)

          if [ -z "$CHANGED_FILES" ]; then
            echo "No TypeScript/JavaScript files changed"
            echo "has_files=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Save to file for next step
          echo "$CHANGED_FILES" > changed_files.txt
          echo "has_files=true" >> $GITHUB_OUTPUT

      - name: Run AI code review
        if: steps.changed-files.outputs.has_files == 'true'
        id: review
        run: |
          # Run code review on changed files
          FILES=$(cat changed_files.txt | tr '\n' ' ')
          npx tsx scripts/ollama-code-review.ts $FILES > review_output.txt 2>&1 || true

          # Check if review found issues
          if grep -q "Critical" review_output.txt; then
            echo "has_critical=true" >> $GITHUB_OUTPUT
          else
            echo "has_critical=false" >> $GITHUB_OUTPUT
          fi

          # Prepare comment body (escape for JSON)
          echo "REVIEW_OUTPUT<<EOF" >> $GITHUB_ENV
          cat review_output.txt >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Post review comment on PR
        if: steps.changed-files.outputs.has_files == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const reviewOutput = process.env.REVIEW_OUTPUT;
            const hasCritical = '${{ steps.review.outputs.has_critical }}' === 'true';

            const icon = hasCritical ? '‚ö†Ô∏è' : '‚úÖ';
            const title = hasCritical ? 'Critical Issues Found' : 'Code Review Completed';

            const comment = `## ${icon} AI Code Review - ${title}

            <details>
            <summary>üìã View full review (click to expand)</summary>

            \`\`\`
            ${reviewOutput}
            \`\`\`

            </details>

            ---
            ü§ñ Powered by **qwen2.5-coder:32b** running locally on RTX 3090
            ‚ö° $0 cost ‚Ä¢ üîí 100% private ‚Ä¢ ‚öôÔ∏è Generated by Ollama
            `;

            // Post comment on PR
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

      - name: Check for critical issues
        if: steps.review.outputs.has_critical == 'true'
        run: |
          echo "‚ö†Ô∏è  Critical issues found in code review"
          echo "Review the issues above and address them before merging"
          # Don't fail the workflow, just warn
          exit 0
