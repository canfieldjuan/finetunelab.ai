# Render.com Blueprint - FinetuneLab Infrastructure as Code
# This file defines your Render services declaratively
# Docs: https://render.com/docs/blueprint-spec

services:
  # Production Web Service
  - type: web
    name: finetunelab-production
    env: node
    region: oregon
    plan: starter  # Change to 'pro' or 'standard' as needed
    buildCommand: npm ci && npm run build
    startCommand: npm start
    healthCheckPath: /api/health
    envVars:
      - key: NODE_ENV
        value: production
      - key: NEXT_PUBLIC_SUPABASE_URL
        sync: false  # Set via Render Dashboard
      - key: NEXT_PUBLIC_SUPABASE_ANON_KEY
        sync: false
      - key: SUPABASE_SERVICE_ROLE_KEY
        sync: false
      - key: OPENAI_API_KEY
        sync: false
      - key: ANTHROPIC_API_KEY
        sync: false
      - key: NODE_OPTIONS
        value: --max-old-space-size=4096
      - key: NEXT_PUBLIC_BASE_URL
        value: https://finetunelab.ai
      - key: NEXT_PUBLIC_APP_URL
        value: https://finetunelab.ai
      # BYOM (Bring Your Own Model) Configuration
      - key: DEMO_ENCRYPTION_KEY
        sync: false  # Set via Render Dashboard - generate with: node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
      - key: CRON_SECRET
        sync: false  # Set via Render Dashboard - generate with: openssl rand -base64 32
    autoDeploy: false  # Controlled via GitHub Actions

  # Staging Web Service
  - type: web
    name: finetunelab-staging
    env: node
    region: oregon
    plan: starter
    buildCommand: npm ci && npm run build
    startCommand: npm start
    healthCheckPath: /api/health
    branch: develop  # Auto-deploy from develop branch
    envVars:
      - key: NODE_ENV
        value: production
      - key: NEXT_PUBLIC_SUPABASE_URL
        sync: false
      - key: NEXT_PUBLIC_SUPABASE_ANON_KEY
        sync: false
      - key: SUPABASE_SERVICE_ROLE_KEY
        sync: false
      - key: NODE_OPTIONS
        value: --max-old-space-size=4096
      - key: NEXT_PUBLIC_BASE_URL
        value: https://finetunelab-staging.onrender.com
      - key: NEXT_PUBLIC_APP_URL
        value: https://finetunelab-staging.onrender.com
      # BYOM Configuration
      - key: DEMO_ENCRYPTION_KEY
        sync: false
      - key: CRON_SECRET
        sync: false
    autoDeploy: true  # Auto-deploy from develop branch

  # Redis Cache (Optional - if using Redis)
  # - type: redis
  #   name: finetunelab-cache
  #   plan: starter
  #   maxmemoryPolicy: allkeys-lru
  #   ipAllowList: []  # Empty = allow all

  # Background Worker - Evaluation Scheduler
  - type: worker
    name: finetunelab-scheduler-worker
    env: node
    region: oregon
    plan: starter
    buildCommand: npm ci
    startCommand: npm run scheduler:start
    envVars:
      - key: NODE_ENV
        value: production
      - key: NEXT_PUBLIC_SUPABASE_URL
        sync: false
      - key: NEXT_PUBLIC_SUPABASE_ANON_KEY
        sync: false
      - key: SUPABASE_SERVICE_ROLE_KEY
        sync: false
      - key: NEXT_PUBLIC_APP_URL
        value: https://finetunelab.ai
      - key: NEXT_PUBLIC_BASE_URL
        value: https://finetunelab.ai
    autoDeploy: true

  # BYOM Cron Job - Cleanup Expired Demo Sessions
  - type: cron
    name: cleanup-demo-sessions
    schedule: "0 * * * *"  # Every hour
    buildCommand: npm ci
    startCommand: |
      curl -X DELETE https://finetunelab.ai/api/cron/cleanup-demo-sessions \
        -H "Authorization: Bearer $CRON_SECRET" \
        || echo "Cleanup cron failed"
    envVars:
      - key: CRON_SECRET
        sync: false

# Environment Variable Groups
# Create these in Render Dashboard: Account Settings â†’ Environment Groups
# envVarGroups:
#   - name: finetunelab-env-group
#     envVars:
#       - key: SUPABASE_URL
#       - key: SUPABASE_ANON_KEY
#       - key: DATABASE_URL

databases:
  # PostgreSQL Database (if not using Supabase)
  # - name: finetunelab-db
  #   databaseName: finetunelab
  #   user: finetunelab
  #   plan: starter
  #   region: oregon
  #   ipAllowList: []
