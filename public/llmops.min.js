"use strict";var LLMOpsSDK=(()=>{var r=Object.defineProperty;var c=Object.getOwnPropertyDescriptor;var d=Object.getOwnPropertyNames;var f=Object.prototype.hasOwnProperty;var g=(t,e)=>{for(var s in e)r(t,s,{get:e[s],enumerable:!0})},S=(t,e,s,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of d(e))!f.call(t,n)&&n!==s&&r(t,n,{get:()=>e[n],enumerable:!(i=c(e,n))||i.enumerable});return t};var p=t=>S(r({},"__esModule",{value:!0}),t);var L={};g(L,{LLMOps:()=>h,LLMOpsSDK:()=>a});var m="1.0.0";var u="__llmops_queue",l="__llmops_session",a=class{constructor(e){this.queue=[],this.userId=null,this.userTraits={},this.flushTimer=null,this.sending=!1,this.config={...e,flushIntervalMs:e.flushIntervalMs??1500,maxBatch:e.maxBatch??50,maxQueueSize:e.maxQueueSize??1e3,onBeforeSend:e.onBeforeSend??(s=>s),debug:e.debug??!1},this.sessionId=this.getOrCreateSession(),this.loadQueue(),this.startFlushTimer(),this.setupUnloadHandler(),this.log("SDK initialized",this.config)}identify(e){this.userId=e.userId,this.userTraits=e.traits||{},this.log("User identified:",e)}event(e){if(!e.type||!e.ts){this.log("Invalid event (missing type or ts):",e);return}let s=e;if(this.config.onBeforeSend){let n=this.config.onBeforeSend(e);if(!n){this.log("Event filtered by onBeforeSend:",e);return}s=n}let i={...s,_meta:{appId:this.config.appId,sessionId:this.sessionId,page:window.location.pathname,userAgent:navigator.userAgent,sdkVersion:m,timestamp:Date.now()}};this.queue.push(i),this.log("Event queued:",i),this.queue.length>=this.config.maxBatch&&this.flush(),this.saveQueue()}async flush(){if(this.sending||this.queue.length===0)return;let e=this.queue.splice(0,this.config.maxBatch);this.sending=!0,this.log("Flushing batch:",e.length,"events");try{await this.sendBatch(e),this.log("Batch sent successfully"),this.saveQueue()}catch(s){this.log("Batch send failed, re-queuing:",s),this.queue.unshift(...e),this.saveQueue()}finally{this.sending=!1}}async sendBatch(e){let s={events:e,user:this.userId?{id:this.userId,traits:this.userTraits}:null};if(navigator.sendBeacon){let n=new Blob([JSON.stringify(s)],{type:"application/json"});if(navigator.sendBeacon(this.config.endpoint,n))return}let i=await fetch(this.config.endpoint,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.config.token}`},body:JSON.stringify(s),keepalive:!0});if(!i.ok)throw new Error(`HTTP ${i.status}: ${i.statusText}`)}startFlushTimer(){this.flushTimer&&clearInterval(this.flushTimer),this.flushTimer=window.setInterval(()=>{this.flush()},this.config.flushIntervalMs)}setupUnloadHandler(){window.addEventListener("beforeunload",()=>{this.flush()}),document.addEventListener("visibilitychange",()=>{document.hidden&&this.flush()})}getOrCreateSession(){try{let s=sessionStorage.getItem(l);if(s)return s}catch{this.log("SessionStorage not available")}let e=`sess_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;try{sessionStorage.setItem(l,e)}catch{this.log("Failed to save session")}return e}loadQueue(){try{let e=localStorage.getItem(u);if(e){let s=JSON.parse(e);Array.isArray(s)&&(this.queue=s.slice(0,this.config.maxQueueSize),this.log("Loaded queue from storage:",this.queue.length,"events"))}}catch(e){this.log("Failed to load queue:",e)}}saveQueue(){try{let e=this.queue.slice(0,this.config.maxQueueSize);localStorage.setItem(u,JSON.stringify(e))}catch(e){if(this.log("Failed to save queue:",e),e instanceof Error&&e.name==="QuotaExceededError"){this.queue=this.queue.slice(-Math.floor(this.config.maxQueueSize/2));try{localStorage.setItem(u,JSON.stringify(this.queue))}catch(s){this.log("Failed to save reduced queue:",s)}}}}log(...e){this.config.debug&&console.log("[LLMOps]",...e)}},o=null;function h(t,e){if(t==="init"){if(o=new a(e),window.LLMOps?.q){let s=window.LLMOps.q;for(let[i,n]of s)i!=="init"&&h(i,n);window.LLMOps.q=[]}return}if(!o){console.warn('[LLMOps] SDK not initialized. Call LLMOps("init", config) first');return}switch(t){case"identify":o.identify(e);break;case"event":o.event(e);break;case"flush":o.flush();break;default:console.warn("[LLMOps] Unknown command:",t)}}typeof window<"u"&&(window.LLMOps=h,window.LLMOpsSDK=a);return p(L);})();
